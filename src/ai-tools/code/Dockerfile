# Claude Tools + æœ¬åœ°å¤§æ¨¡å‹ ä»£ç†æœåŠ¡é•œåƒ
# ä¼˜åŒ–ç‰ˆæœ¬ï¼šæ”¯æŒå¤šæ¶æ„ã€Claude Toolsé›†æˆã€ç”Ÿäº§å°±ç»ª

FROM python:3.11-slim as base

# æ„å»ºå‚æ•°
ARG CLAUDE_TOOLS_VERSION=latest
ARG TARGETPLATFORM

# è®¾ç½®æ ‡ç­¾
LABEL maintainer="youweichen0208@gmail.com"
LABEL description="Claude Tools Local LLM Proxy Service"
LABEL version="1.0.0"

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    POETRY_NO_INTERACTION=1

# å·¥ä½œç›®å½•
WORKDIR /app

# ç³»ç»Ÿä¾èµ–å®‰è£…é˜¶æ®µ
FROM base as system-deps

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    gcc \
    g++ \
    libc6-dev \
    libffi-dev \
    libssl-dev \
    ca-certificates \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Pythonä¾èµ–å®‰è£…é˜¶æ®µ
FROM system-deps as python-deps

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd --gid 1000 appuser \
    && useradd --uid 1000 --gid appuser --shell /bin/bash --create-home appuser

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir --upgrade pip setuptools wheel \
    && pip install --no-cache-dir -r requirements.txt

# åº”ç”¨æ„å»ºé˜¶æ®µ
FROM python-deps as app

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY local_llm_proxy.py .
COPY claude_tools_integration.py .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /app/logs /app/config /app/cache \
    && chown -R appuser:appuser /app

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY config/ ./config/

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¯åŠ¨ Claude Tools æœ¬åœ°å¤§æ¨¡å‹ä»£ç†æœåŠ¡..."

# å¥åº·æ£€æŸ¥å‡½æ•°
health_check() {
    local service=$1
    local url=$2
    local max_attempts=30
    local attempt=1

    echo "â³ ç­‰å¾… $service æœåŠ¡å¯åŠ¨..."
    while [ $attempt -le $max_attempts ]; do
        if curl -f "$url" >/dev/null 2>&1; then
            echo "âœ… $service æœåŠ¡å·²å¯åŠ¨"
            return 0
        fi
        echo "   å°è¯• $attempt/$max_attempts ..."
        sleep 2
        ((attempt++))
    done
    echo "âŒ $service æœåŠ¡å¯åŠ¨è¶…æ—¶"
    return 1
}

# ç­‰å¾…ä¾èµ–æœåŠ¡
if [ "$OLLAMA_HOST" ]; then
    health_check "Ollama" "http://${OLLAMA_HOST}/api/tags"
fi

if [ "$REDIS_URL" ]; then
    redis_host=$(echo $REDIS_URL | cut -d'/' -f3 | cut -d':' -f1)
    redis_port=$(echo $REDIS_URL | cut -d'/' -f3 | cut -d':' -f2)
    health_check "Redis" "http://${redis_host}:${redis_port}"
fi

# å¯åŠ¨åº”ç”¨
echo "ğŸ”¥ å¯åŠ¨ä»£ç†æœåŠ¡..."
exec python local_llm_proxy.py \
    --host "${PROXY_HOST:-0.0.0.0}" \
    --port "${PROXY_PORT:-8000}" \
    --log-level "${LOG_LEVEL:-info}"
EOF

RUN chmod +x /app/start.sh

# ç”Ÿäº§é˜¶æ®µ
FROM app as production

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# å®¹å™¨æ ‡ç­¾
LABEL claude-tools.enabled="true" \
      claude-tools.version="${CLAUDE_TOOLS_VERSION}" \
      build.date="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
      build.platform="${TARGETPLATFORM}"

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start.sh"]

# å¼€å‘é˜¶æ®µï¼ˆå¯é€‰ï¼‰
FROM app as development

# å®‰è£…å¼€å‘ä¾èµ–
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    black \
    flake8 \
    mypy

# å¼€å‘æ¨¡å¼å¯åŠ¨
CMD ["python", "-m", "uvicorn", "local_llm_proxy:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]